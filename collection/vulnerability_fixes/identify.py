import sys
import pandas as pd
from ast import literal_eval

sys.path.append('..')
from finder import *  # noqa: E402


def identify_applicable_vulnerabilities(date, to_version, package, database):
    ghsa_s = []
    version_range = []
    first_patched = []
    time_mask = database['publishedAt'] <= date
    package_mask = database['package'] == package
    database = database[time_mask & package_mask]
    ws_advisory_met = False
    for index, advisory in database.iterrows():
        affected_range = advisory['vulnerableVersionRange'].replace(' ', '').replace(',', ' ')
        first_patched_version = advisory['firstPatchedVersion']
        if advisory['ghsa'] == 'GHSA-vh95-rmgr-6w4m':
            if (to_version == '1.2.2') & ('1.2.3' in affected_range):
                affected_range = '>=1.0.0 <1.2.2'
                first_patched_version = '1.2.2'
        elif advisory['ghsa'] == 'GHSA-6chw-6frg-f759':
            if '5.7.4' in affected_range:
                affected_range = '>=5.1.2 <5.7.4'
                first_patched_version = '5.7.4'
        elif advisory['ghsa'] == 'GHSA-5v72-xg48-5rpm':
            if date <= datetime.strptime('2019-12-09T23:59:59Z', '%Y-%m-%dT%H:%M:%SZ'):
                if not ws_advisory_met:
                    affected_range = '>=0.2.6 <3.3.1'
                    first_patched_version = '3.3.1'
                    ws_advisory_met = True
                else:
                    continue
        elif advisory['ghsa'] == 'GHSA-6c8f-qphg-qjgp':
            if date <= datetime.strptime('2020-11-06T23:59:59Z', '%Y-%m-%dT%H:%M:%SZ'):
                affected_range = '<6.0.3'
        ghsa_s.append(advisory['ghsa'])
        version_range.append(affected_range)
        first_patched.append(first_patched_version)
    return pd.DataFrame({'ghsa': ghsa_s, 'vulnerableVersionRange': version_range, 'firstPatchedVersion': first_patched})

